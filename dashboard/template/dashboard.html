<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingBot Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.1/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running { background-color: #4CAF50; }
        .status-stopped { background-color: #f44336; }
        .status-unknown { background-color: #ff9800; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .positive { color: #4CAF50; }
        .negative { color: #f44336; }
        .neutral { color: #666; }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 1rem;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            text-decoration: none;
            color: #666;
        }

        .nav-tab:hover, .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .positions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .position-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #fafafa;
        }

        .position-symbol {
            font-weight: 600;
            font-size: 1rem;
        }

        .position-details {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
        }

        .recent-trades {
            max-height: 300px;
            overflow-y: auto;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-side {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .buy { background: #e8f5e8; color: #2e7d32; }
        .sell { background: #ffebee; color: #c62828; }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <span id="status-indicator" class="status-indicator status-unknown"></span>
            TradingBot Dashboard
        </h1>
        <p>Live-Monitoring • Portfolio-Performance • Trade-Analyse</p>
    </header>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <a href="#" class="nav-tab active" data-tab="overview">Übersicht</a>
            <a href="/backtest" class="nav-tab">Backtest</a>
            <a href="/trades" class="nav-tab">Trades</a>
            <a href="/settings" class="nav-tab">Einstellungen</a>
        </div>

        <!-- Status Alert -->
        <div id="status-alert" class="alert alert-warning" style="display: none;">
            <strong>Warnung:</strong> <span id="status-message"></span>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- System Status Card -->
            <div class="card">
                <div class="card-title">
                    🤖 System Status
                    <button class="refresh-btn" onclick="refreshData()">Aktualisieren</button>
                </div>
                <div id="system-metrics">
                    <div class="loading">
                        <div class="spinner"></div>
                        Lade Status...
                    </div>
                </div>
            </div>

            <!-- Portfolio Performance Card -->
            <div class="card">
                <div class="card-title">💰 Portfolio Performance</div>
                <div id="portfolio-metrics">
                    <div class="loading">
                        <div class="spinner"></div>
                        Lade Portfolio...
                    </div>
                </div>
            </div>

            <!-- Current Positions Card -->
            <div class="card">
                <div class="card-title">📊 Aktuelle Positionen</div>
                <div id="positions-list" class="positions-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Lade Positionen...
                    </div>
                </div>
            </div>

            <!-- Recent Trades Card -->
            <div class="card">
                <div class="card-title">📈 Letzte Trades</div>
                <div id="recent-trades" class="recent-trades">
                    <div class="loading">
                        <div class="spinner"></div>
                        Lade Trades...
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="card">
            <div class="card-title">📈 Portfolio-Entwicklung (Heute)</div>
            <div id="performance-chart" class="chart-container"></div>
        </div>

        <!-- Strategy Info -->
        <div class="card">
            <div class="card-title">🧠 Strategie-Informationen</div>
            <div id="strategy-info">
                <div class="loading">
                    <div class="spinner"></div>
                    Lade Strategie-Info...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let refreshInterval;
        let lastUpdateTime = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            startAutoRefresh();
        });

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadSystemStatus(),
                    loadPortfolioData(),
                    loadPositions(),
                    loadRecentTrades(),
                    loadPerformanceChart(),
                    loadStrategyInfo()
                ]);
                
                lastUpdateTime = new Date();
                updateStatusIndicator('running');
                
            } catch (error) {
                console.error('Fehler beim Laden der Dashboard-Daten:', error);
                updateStatusIndicator('error');
                showAlert('Fehler beim Laden der Daten: ' + error.message, 'error');
            }
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Fehler beim Laden des Status');
                }

                const systemMetrics = document.getElementById('system-metrics');
                systemMetrics.innerHTML = `
                    <div class="metric">
                        <span>Bot Status:</span>
                        <span class="metric-value ${data.is_running ? 'positive' : 'negative'}">
                            ${data.is_running ? '✅ Läuft' : '❌ Gestoppt'}
                        </span>
                    </div>
                    <div class="metric">
                        <span>Markt Status:</span>
                        <span class="metric-value ${data.market_open ? 'positive' : 'neutral'}">
                            ${data.market_open ? '🟢 Geöffnet' : '🔴 Geschlossen'}
                        </span>
                    </div>
                    <div class="metric">
                        <span>Account Value:</span>
                        <span class="metric-value">${formatCurrency(data.account_value || 0)}</span>
                    </div>
                    <div class="metric">
                        <span>Kaufkraft:</span>
                        <span class="metric-value">${formatCurrency(data.buying_power || 0)}</span>
                    </div>
                    <div class="metric">
                        <span>Aktive Positionen:</span>
                        <span class="metric-value">${data.positions_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span>Letztes Signal:</span>
                        <span class="metric-value neutral">
                            ${data.last_signal_time ? formatDateTime(data.last_signal_time) : 'Noch keine'}
                        </span>
                    </div>
                `;

                updateStatusIndicator(data.is_running ? 'running' : 'stopped');

            } catch (error) {
                console.error('Fehler beim Laden des System-Status:', error);
                document.getElementById('system-metrics').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden des Status</div>';
            }
        }

        async function loadPortfolioData() {
            try {
                const [portfolioResponse, performanceResponse] = await Promise.all([
                    fetch('/api/portfolio'),
                    fetch('/api/performance')
                ]);

                const portfolioData = await portfolioResponse.json();
                const performanceData = await performanceResponse.json();

                if (!portfolioResponse.ok || !performanceResponse.ok) {
                    throw new Error('Fehler beim Laden der Portfolio-Daten');
                }

                const portfolioMetrics = document.getElementById('portfolio-metrics');
                portfolioMetrics.innerHTML = `
                    <div class="metric">
                        <span>Portfolio-Wert:</span>
                        <span class="metric-value">${formatCurrency(performanceData.current_equity)}</span>
                    </div>
                    <div class="metric">
                        <span>Täglicher P&L:</span>
                        <span class="metric-value ${performanceData.daily_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(performanceData.daily_pnl)} (${formatPercentage(performanceData.daily_return)})
                        </span>
                    </div>
                    <div class="metric">
                        <span>Unrealisierte P&L:</span>
                        <span class="metric-value ${performanceData.total_unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(performanceData.total_unrealized_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span>Verfügbares Cash:</span>
                        <span class="metric-value">${formatCurrency(performanceData.cash)}</span>
                    </div>
                    <div class="metric">
                        <span>Kaufkraft:</span>
                        <span class="metric-value">${formatCurrency(performanceData.buying_power)}</span>
                    </div>
                `;

            } catch (error) {
                console.error('Fehler beim Laden der Portfolio-Daten:', error);
                document.getElementById('portfolio-metrics').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden der Portfolio-Daten</div>';
            }
        }

        async function loadPositions() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Fehler beim Laden der Positionen');
                }

                const positionsList = document.getElementById('positions-list');
                
                if (!data.positions || data.positions.length === 0) {
                    positionsList.innerHTML = '<div class="neutral" style="text-align: center; padding: 2rem;">Keine offenen Positionen</div>';
                    return;
                }

                let positionsHtml = '';
                data.positions.forEach(position => {
                    const pnlClass = position.unrealized_pnl >= 0 ? 'positive' : 'negative';
                    positionsHtml += `
                        <div class="position-item">
                            <div>
                                <div class="position-symbol">${position.symbol}</div>
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${position.qty} Aktien @ ${formatCurrency(position.avg_entry_price)}
                                </div>
                            </div>
                            <div class="position-details">
                                <div class="${pnlClass}">${formatCurrency(position.unrealized_pnl)}</div>
                                <div style="font-size: 0.8rem;">
                                    ${formatCurrency(position.current_price)} (${formatPercentage(position.unrealized_pnl_pct)})
                                </div>
                            </div>
                        </div>
                    `;
                });

                positionsList.innerHTML = positionsHtml;

            } catch (error) {
                console.error('Fehler beim Laden der Positionen:', error);
                document.getElementById('positions-list').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden der Positionen</div>';
            }
        }

        async function loadRecentTrades() {
            try {
                const response = await fetch('/api/trades?limit=10');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Fehler beim Laden der Trades');
                }

                const recentTrades = document.getElementById('recent-trades');
                
                if (!data.trades || data.trades.length === 0) {
                    recentTrades.innerHTML = '<div class="neutral" style="text-align: center; padding: 2rem;">Keine Trades vorhanden</div>';
                    return;
                }

                let tradesHtml = '';
                data.trades.slice(0, 10).forEach(trade => {
                    const sideClass = trade.side === 'buy' ? 'buy' : 'sell';
                    tradesHtml += `
                        <div class="trade-item">
                            <div>
                                <span class="trade-side ${sideClass}">${trade.side.toUpperCase()}</span>
                                <strong>${trade.symbol}</strong>
                                <span style="font-size: 0.9rem; color: #666;">
                                    ${trade.filled_quantity} @ ${formatCurrency(trade.filled_avg_price || trade.price)}
                                </span>
                            </div>
                            <div style="text-align: right; font-size: 0.8rem; color: #666;">
                                ${formatDateTime(trade.timestamp)}
                            </div>
                        </div>
                    `;
                });

                recentTrades.innerHTML = tradesHtml;

            } catch (error) {
                console.error('Fehler beim Laden der Trades:', error);
                document.getElementById('recent-trades').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden der Trades</div>';
            }
        }

        async function loadPerformanceChart() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Fehler beim Laden der Chart-Daten');
                }

                if (!data.history || data.history.length === 0) {
                    document.getElementById('performance-chart').innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #666;">Keine Chart-Daten verfügbar</div>';
                    return;
                }

                // Bereite Daten für Chart vor
                const timestamps = data.history.map(item => new Date(item.timestamp));
                const equity = data.history.map(item => item.equity);
                const profitLoss = data.history.map(item => item.profit_loss);

                const trace1 = {
                    x: timestamps,
                    y: equity,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio-Wert',
                    line: { color: '#667eea', width: 2 }
                };

                const trace2 = {
                    x: timestamps,
                    y: profitLoss,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'P&L',
                    yaxis: 'y2',
                    line: { color: '#764ba2', width: 2 }
                };

                const layout = {
                    title: '',
                    xaxis: { 
                        title: 'Zeit',
                        type: 'date'
                    },
                    yaxis: { 
                        title: 'Portfolio-Wert ($)',
                        side: 'left'
                    },
                    yaxis2: {
                        title: 'P&L ($)',
                        overlaying: 'y',
                        side: 'right'
                    },
                    legend: { x: 0, y: 1 },
                    margin: { t: 30, r: 50, b: 50, l: 60 },
                    plot_bgcolor: '#fafafa',
                    paper_bgcolor: 'white'
                };

                Plotly.newPlot('performance-chart', [trace1, trace2], layout, {responsive: true});

            } catch (error) {
                console.error('Fehler beim Laden des Performance-Charts:', error);
                document.getElementById('performance-chart').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden des Charts</div>';
            }
        }

        async function loadStrategyInfo() {
            try {
                const response = await fetch('/api/strategy/info');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Fehler beim Laden der Strategie-Info');
                }

                const strategyInfo = document.getElementById('strategy-info');
                strategyInfo.innerHTML = `
                    <div class="metric">
                        <span>Strategie:</span>
                        <span class="metric-value">${data.name || 'Unbekannt'}</span>
                    </div>
                    <div class="metric">
                        <span>Modell:</span>
                        <span class="metric-value">${data.model_type || 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span>Status:</span>
                        <span class="metric-value ${data.is_fitted ? 'positive' : 'negative'}">
                            ${data.is_fitted ? '✅ Trainiert' : '❌ Nicht trainiert'}
                        </span>
                    </div>
                    <div class="metric">
                        <span>Training Score:</span>
                        <span class="metric-value">${(data.training_score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span>Features:</span>
                        <span class="metric-value">${data.feature_count || 0}</span>
                    </div>
                    <div class="metric">
                        <span>Lookback Period:</span>
                        <span class="metric-value">${data.lookback_period || 'N/A'}</span>
                    </div>
                `;

                // Zeige Top-Features falls verfügbar
                if (data.top_features && data.top_features.length > 0) {
                    strategyInfo.innerHTML += '<hr style="margin: 1rem 0;"><strong>Top Features:</strong>';
                    data.top_features.forEach(feature => {
                        strategyInfo.innerHTML += `
                            <div class="metric" style="font-size: 0.9rem;">
                                <span>${feature.feature}:</span>
                                <span class="metric-value">${(feature.importance * 100).toFixed(1)}%</span>
                            </div>
                        `;
                    });
                }

            } catch (error) {
                console.error('Fehler beim Laden der Strategie-Info:', error);
                document.getElementById('strategy-info').innerHTML = 
                    '<div class="alert alert-error">Fehler beim Laden der Strategie-Info</div>';
            }
        }

        function refreshData() {
            loadDashboardData();
        }

        function startAutoRefresh() {
            // Aktualisiere alle 30 Sekunden
            refreshInterval = setInterval(() => {
                loadDashboardData();
            }, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function updateStatusIndicator(status) {
            const indicator = document.getElementById('status-indicator');
            indicator.className = `status-indicator status-${status}`;
        }

        function showAlert(message, type = 'warning') {
            const alert = document.getElementById('status-alert');
            const messageSpan = document.getElementById('status-message');
            
            messageSpan.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';

            // Auto-hide nach 5 Sekunden
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Utility functions
        function formatCurrency(value) {
            if (value === null || value === undefined) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercentage(value) {
            if (value === null || value === undefined) return '0.00%';
            return (value * 100).toFixed(2) + '%';
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Navigation
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('nav-tab')) {
                e.preventDefault();
                
                // Entferne active class von allen tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Füge active class zum geklickten tab hinzu
                e.target.classList.add('active');
                
                // Navigation zu anderen Seiten
                if (e.target.getAttribute('href') !== '#') {
                    window.location.href = e.target.getAttribute('href');
                }
            }
        });

        // Cleanup beim Verlassen der Seite
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Visibility API - pausiere Updates wenn Tab nicht sichtbar
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                loadDashboardData();
            }
        });
    </script>
</body>
</html>